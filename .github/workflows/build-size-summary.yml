name: "Build Size Summary"

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

defaults:
  run:
    shell: pwsh

jobs:
  build-size-summary:
    name: Build Size Summary
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && !startsWith(github.event.workflow_run.head_branch, 'release/') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Download all build size measurements
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: build-size-*
          path: build-size-measurements
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create consolidated summary
        run: |
          $measurements = @()
          Get-ChildItem -Path "build-size-measurements" -Recurse -Filter "*.json" | ForEach-Object {
              $data = Get-Content $_.FullName -Raw | ConvertFrom-Json
              $measurements += $data
          }

          if ($measurements.Count -eq 0) {
              Write-Host "No build size measurements found. Skipping summary."
              exit 0
          }

          $summary = @"
          ## ðŸ“Š Build Size Impact Summary

          | Platform | Without Sentry | With Sentry | Difference | Change % |
          |----------|----------------|-------------|------------|----------|
          "@

          $measurements | Sort-Object Platform | ForEach-Object {
              $withoutSize = if ($_.WithoutSentry -lt 1KB) { "$($_.WithoutSentry) B" }
                            elseif ($_.WithoutSentry -lt 1MB) { "{0:N2} KB" -f ($_.WithoutSentry / 1KB) }
                            elseif ($_.WithoutSentry -lt 1GB) { "{0:N2} MB" -f ($_.WithoutSentry / 1MB) }
                            else { "{0:N2} GB" -f ($_.WithoutSentry / 1GB) }

              $withSize = if ($_.WithSentry -lt 1KB) { "$($_.WithSentry) B" }
                         elseif ($_.WithSentry -lt 1MB) { "{0:N2} KB" -f ($_.WithSentry / 1KB) }
                         elseif ($_.WithSentry -lt 1GB) { "{0:N2} MB" -f ($_.WithSentry / 1MB) }
                         else { "{0:N2} GB" -f ($_.WithSentry / 1GB) }

              $diffSize = if ([Math]::Abs($_.Difference) -lt 1KB) { "$([Math]::Abs($_.Difference)) B" }
                         elseif ([Math]::Abs($_.Difference) -lt 1MB) { "{0:N2} KB" -f ([Math]::Abs($_.Difference) / 1KB) }
                         elseif ([Math]::Abs($_.Difference) -lt 1GB) { "{0:N2} MB" -f ([Math]::Abs($_.Difference) / 1MB) }
                         else { "{0:N2} GB" -f ([Math]::Abs($_.Difference) / 1GB) }

              $sign = if ($_.Difference -gt 0) { "+" } elseif ($_.Difference -lt 0) { "-" } else { "" }
              $percentSign = if ($_.PercentChange -gt 0) { "+" } elseif ($_.PercentChange -lt 0) { "-" } else { "" }

              $summary += "`n| $($_.Platform) | $withoutSize | $withSize | $sign$diffSize | $percentSign$([Math]::Round([Math]::Abs($_.PercentChange), 2))% |"
          }

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY
